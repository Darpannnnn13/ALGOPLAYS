<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sudoku | {{ difficulty.upper() }} Level {{ level }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #sudoku-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 2px;
            width: 470px;
            height: 470px;
            background-color: #4A5568;
            border: 2px solid #4A5568;
        }
        .sudoku-cell {
            width: 100%;
            height: 100%;
            text-align: center;
            font-size: 1.5rem;
            border: 1px solid #2D3748;
            background-color: #1A202C;
            color: white;
            caret-color: #4ade80; /* Green cursor */
        }
        .sudoku-cell.given {
            background-color: #2D3748;
            color: #A0AEC0;
        }
        .sudoku-cell:read-only {
            cursor: not-allowed;
        }
        /* Create thicker grid lines */
        .sudoku-cell:nth-child(3n) { border-right: 2px solid #4A5568; }
        .sudoku-cell:nth-child(n+19):nth-child(-n+27),
        .sudoku-cell:nth-child(n+46):nth-child(-n+54) {
            border-bottom: 2px solid #4A5568;
        }
        /* Custom Modal for Win Message */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); display: flex; align-items: center;
            justify-content: center; z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: #2D3748; padding: 2rem; border-radius: 8px;
            text-align: center; color: white; transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
    </style>
</head>
<body class="bg-gray-900 text-white p-10 min-h-screen flex flex-col items-center">

    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-green-400">Sudoku Solver</h1>
        <h2 class="text-2xl text-gray-400">{{ difficulty.capitalize() }} Level {{ level }}</h2>
    </div>

    <div class="w-full max-w-4xl flex justify-center">
        <div class="flex justify-center gap-4 mb-6">
            <a href="/sudoku/levels" class="px-4 py-2 bg-blue-500 text-black rounded font-bold hover:bg-blue-400">‚¨ÖÔ∏è Levels</a>
            <button id="play-check-btn" class="px-4 py-2 bg-green-500 text-black rounded font-bold hover:bg-green-400 w-48">‚ñ∂Ô∏è User Play</button>
            <button onclick="location.reload()" class="px-4 py-2 bg-yellow-500 text-black rounded font-bold hover:bg-yellow-400">üîÅ Restart</button>
            {% if level < 5 %}
                <a href="/level/sudoku/{{ difficulty }}/{{ level + 1 }}" class="px-4 py-2 bg-green-600 text-black rounded font-bold hover:bg-green-500">Next Level ‚û°Ô∏è</a>
            {% endif %}
        </div>
    </div>

    <div class="flex flex-row gap-8 items-start">
        <div class="flex flex-col gap-3">
            <button onclick="runAI('DFS')" class="px-4 py-2 bg-purple-500 text-black rounded font-bold hover:bg-purple-400 w-48">Run DFS (Backtracking)</button>
            <button onclick="runAI('A*')" class="px-4 py-2 bg-pink-500 text-black rounded font-bold hover:bg-pink-400 w-48">Run A* (MRV)</button>
            <button onclick="runAI('AC-3')" class="px-4 py-2 bg-teal-500 text-black rounded font-bold hover:bg-teal-400 w-48">Run AC-3</button>
            <button id="reset-grid-btn" class="px-4 py-2 bg-gray-600 text-white rounded font-bold hover:bg-gray-500 w-48 mt-4">Reset Grid</button>
        </div>

        <div id="sudoku-grid"></div>

        <div class="flex flex-col gap-4 text-sm w-80">
            <div class="p-3 rounded bg-yellow-800/20 border border-yellow-400">
                <div class="font-bold text-yellow-400">Your Time</div>
                <div><span id="userTime">0.00</span>s</div>
            </div>
            <div class="p-3 rounded bg-purple-800/20 border border-purple-400">
                <div class="font-bold text-purple-400">DFS Time</div>
                <div><span id="dfs-time">N/A</span></div>
            </div>
            <div class="p-3 rounded bg-pink-800/20 border border-pink-400">
                <div class="font-bold text-pink-400">A* Time</div>
                <div><span id="astar-time">N/A</span></div>
            </div>
            <div class="p-3 rounded bg-teal-800/20 border border-teal-400">
                <div class="font-bold text-teal-400">AC-3 Time</div>
                <div><span id="ac3-time">N/A</span></div>
            </div>
        </div>
    </div>

    <!-- Win Message Modal -->
    <div id="win-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-3xl font-bold text-green-400 mb-4">üéâ Puzzle Solved! üéâ</h2>
            <p id="win-message" class="text-lg mb-6"></p>
            <button id="close-modal-btn" class="px-6 py-2 bg-green-500 text-black font-bold rounded hover:bg-green-400">Close</button>
        </div>
    </div>

    <script>
        const gridEl = document.getElementById('sudoku-grid');
        const userTimeEl = document.getElementById('userTime');
        const dfsTimeEl = document.getElementById('dfs-time');
        const astarTimeEl = document.getElementById('astar-time');
        const ac3TimeEl = document.getElementById('ac3-time');
        const playCheckBtn = document.getElementById('play-check-btn');
        const resetGridBtn = document.getElementById('reset-grid-btn');
        const winModal = document.getElementById('win-modal');
        const winMessage = document.getElementById('win-message');
        const closeModalBtn = document.getElementById('close-modal-btn');

        const initialBoard = {{ board | tojson }};
        const levelKey = `sudoku_{{ difficulty }}-{{ level }}`;
        let userTimer, userStartTime;
        let isPlaying = false;

        function renderBoard(board, isReadOnly) {
            gridEl.innerHTML = '';
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const cell = document.createElement('input');
                    cell.type = 'text';
                    cell.maxLength = 1;
                    cell.className = 'sudoku-cell';
                    cell.dataset.row = r;
                    cell.dataset.col = c;

                    if (board[r][c] !== 0) {
                        cell.value = board[r][c];
                        cell.readOnly = true;
                        cell.classList.add('given');
                    } else {
                        cell.readOnly = isReadOnly;
                    }
                    gridEl.appendChild(cell);
                }
            }
        }

        function startUserTimer() {
            if (userTimer) clearInterval(userTimer);
            userTimeEl.textContent = '0.00';
            userStartTime = Date.now();
            userTimer = setInterval(() => {
                userTimeEl.textContent = ((Date.now() - userStartTime) / 1000).toFixed(2);
            }, 100);
        }

        function getBoardState() {
            const board = Array(9).fill().map(() => Array(9).fill(0));
            const cells = gridEl.querySelectorAll('.sudoku-cell');
            cells.forEach(cell => {
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                const val = parseInt(cell.value);
                if (!isNaN(val) && val >= 1 && val <= 9) {
                    board[row][col] = val;
                }
            });
            return board;
        }

        function checkSolution() {
            const board = getBoardState();
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    if (board[r][c] === 0) {
                        showModal("Board is not complete!");
                        return;
                    }
                    const num = board[r][c];
                    board[r][c] = 0; // Temporarily remove to check validity
                    if (!isCellValid(board, r, c, num)) {
                        showModal(`Error at row ${r+1}, col ${c+1}. Invalid number placement.`);
                        board[r][c] = num;
                        return;
                    }
                    board[r][c] = num;
                }
            }
            // If we reach here, the solution is correct
            clearInterval(userTimer);
            const timeTaken = userTimeEl.textContent;
            
            fetch(`/mark_game_played/${levelKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ human_time: timeTaken })
            });

            showModal(`Congratulations! You solved it in ${timeTaken} seconds!`, true);
        }

        function isCellValid(board, row, col, num) {
            for (let x = 0; x < 9; x++) if (board[row][x] === num) return false;
            for (let x = 0; x < 9; x++) if (board[x][col] === num) return false;
            const startRow = row - row % 3, startCol = col - col % 3;
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    if (board[i + startRow][j + startCol] === num) return false;
                }
            }
            return true;
        }

        function runAI(algo) {
            const algoKey = algo.toLowerCase().replace('*', 'star');
            const timeEl = document.getElementById(`${algoKey}-time`);
            if (timeEl) timeEl.textContent = 'Solving...';

            fetch('/solve_sudoku', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ board: initialBoard, level_key: levelKey, algorithm: algo })
            })
            .then(res => res.json())
            .then(data => {
                if (data.solution) {
                    animateSolution(data.steps, data.solution);
                    if (timeEl) timeEl.textContent = parseFloat(data.ai_time).toFixed(9) + 's';
                } else {
                    if (timeEl) timeEl.textContent = 'No solution found.';
                }
            });
        }
        
        function animateSolution(steps, finalBoard) {
            steps.forEach((step, index) => {
                setTimeout(() => {
                    const [r, c] = step.pos;
                    const cell = gridEl.querySelector(`[data-row='${r}'][data-col='${c}']`);
                    if (step.type === 'place') {
                        cell.value = step.val;
                        cell.style.backgroundColor = '#34D399'; // Green flash
                    } else {
                        cell.value = '';
                        cell.style.backgroundColor = '#F87171'; // Red flash
                    }
                    setTimeout(() => cell.style.backgroundColor = '#1A202C', 200);
                }, index * 20);
            });
             setTimeout(() => renderBoard(finalBoard, true), steps.length * 20 + 200);
        }

        function resetGrid() {
            renderBoard(initialBoard, true);
            isPlaying = false;
            playCheckBtn.textContent = '‚ñ∂Ô∏è User Play';
            if (userTimer) clearInterval(userTimer);
            userTimeEl.textContent = '0.00';
        }

        function showModal(message, isSuccess = false) {
            winMessage.textContent = message;
            const title = winModal.querySelector('h2');
            title.textContent = isSuccess ? 'üéâ Puzzle Solved! üéâ' : 'ü§î Keep Trying...';
            title.className = isSuccess ? 'text-3xl font-bold text-green-400 mb-4' : 'text-3xl font-bold text-yellow-400 mb-4';
            winModal.classList.add('visible');
        }

        playCheckBtn.addEventListener('click', () => {
            if (!isPlaying) {
                isPlaying = true;
                playCheckBtn.textContent = 'Check Solution';
                renderBoard(initialBoard, false); 
                startUserTimer();
            } else {
                checkSolution();
            }
        });

        resetGridBtn.addEventListener('click', resetGrid);
        closeModalBtn.addEventListener('click', () => winModal.classList.remove('visible'));

        renderBoard(initialBoard, true); // Initial render

        // Starfield animation
        const starField = document.getElementById('star-field');
        if (starField && !starField.hasChildNodes()) {
            for (let i = 0; i < 200; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 3;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.left = `${Math.random() * 100}%`;
                star.style.animationDuration = `${2 + Math.random() * 3}s`;
                star.style.animationDelay = `${Math.random() * 5}s`;
                starField.appendChild(star);
            }
        }
    </script>
</body>
</html>
