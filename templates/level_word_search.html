<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Word Search | {{ difficulty.upper() }} Level {{ level }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #word-search-grid {
            display: grid;
            gap: 2px;
            background-color: #4A5568;
            padding: 5px;
            border-radius: 5px;
            transition: opacity 0.3s;
        }
        .disabled-grid {
            pointer-events: none;
            opacity: 0.6;
        }
        .grid-cell {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            background-color: #1A202C;
            color: white;
            user-select: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .grid-cell.selected {
            background-color: #38B2AC; /* Teal */
        }
        .grid-cell.found {
            background-color: #48BB78; /* Green */
        }
        .word-item.found {
            text-decoration: line-through;
            color: #6B7280; /* Gray */
        }
        /* Custom Modal for Win Message */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); display: flex; align-items: center;
            justify-content: center; z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: #2D3748; padding: 2rem; border-radius: 8px;
            text-align: center; color: white; transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
    </style>
</head>
<body class="bg-gray-900 text-white p-10 min-h-screen flex flex-col items-center">

    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-green-400">Word Search</h1>
        <h2 class="text-2xl text-gray-400">{{ difficulty.capitalize() }} Level {{ level }}</h2>
    </div>

    <div class="w-full max-w-5xl flex justify-center">
        <div class="flex justify-center gap-4 mb-6">
            <a href="/word_search/levels" class="px-4 py-2 bg-blue-500 text-black rounded font-bold hover:bg-blue-400">‚¨ÖÔ∏è Levels</a>
            <button id="start-play-btn" class="px-4 py-2 bg-green-500 text-black rounded font-bold hover:bg-green-400">‚ñ∂Ô∏è Start Play</button>
            <button id="reset-grid-btn" class="px-4 py-2 bg-orange-500 text-black rounded font-bold hover:bg-orange-400">üîÑ Reset Grid</button>
            {% if level < 5 %}
                <a href="/level/word_search/{{ difficulty }}/{{ level + 1 }}" class="px-4 py-2 bg-purple-600 text-black rounded font-bold hover:bg-purple-500">Next Level ‚û°Ô∏è</a>
            {% endif %}
        </div>
    </div>

    <div class="flex flex-row gap-8 items-start">
        <div class="flex flex-col gap-3 w-48">
            <h3 class="text-2xl font-bold text-green-400">Words to Find:</h3>
            <ul id="word-list" class="space-y-2"></ul>
            <button onclick="runAI('Simple')" class="px-4 py-2 bg-purple-500 text-black rounded font-bold hover:bg-purple-400 w-full mt-4">Run Simple AI</button>
            <button onclick="runAI('Trie')" class="px-4 py-2 bg-teal-500 text-black rounded font-bold hover:bg-teal-400 w-full mt-2">Run Trie AI (Efficient)</button>
        </div>

        <div id="word-search-grid"></div>

        <div class="flex flex-col gap-4 text-sm w-80">
            <div class="p-3 rounded bg-yellow-800/20 border border-yellow-400">
                <div class="font-bold text-yellow-400">Your Time</div>
                <div><span id="userTime">0.00s</span></div>
            </div>
            <div class="p-3 rounded bg-purple-800/20 border border-purple-400">
                <div class="font-bold text-purple-400">Simple AI Time</div>
                <div><span id="simple-time">N/A</span></div>
            </div>
            <div class="p-3 rounded bg-teal-800/20 border border-teal-400">
                <div class="font-bold text-teal-400">Trie AI Time</div>
                <div><span id="trie-time">N/A</span></div>
            </div>
        </div>
    </div>

    <!-- Win Message Modal -->
    <div id="win-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-3xl font-bold text-green-400 mb-4">üéâ Congratulations! üéâ</h2>
            <p id="win-message" class="text-lg mb-6"></p>
            <button id="close-modal-btn" class="px-6 py-2 bg-green-500 text-black font-bold rounded hover:bg-green-400">Close</button>
        </div>
    </div>

    <script>
        const gridEl = document.getElementById('word-search-grid');
        const wordListEl = document.getElementById('word-list');
        const userTimeEl = document.getElementById('userTime');
        const simpleTimeEl = document.getElementById('simple-time');
        const trieTimeEl = document.getElementById('trie-time');
        const startPlayBtn = document.getElementById('start-play-btn');
        const resetGridBtn = document.getElementById('reset-grid-btn');
        const winModal = document.getElementById('win-modal');
        const winMessage = document.getElementById('win-message');
        const closeModalBtn = document.getElementById('close-modal-btn');

        const gridData = {{ level_data.grid | tojson }};
        const wordsToFind = {{ level_data.words | tojson }};
        const levelKey = `word_search_{{ difficulty }}-{{ level }}`;
        
        let userTimer, userStartTime;
        let isSelecting = false;
        let selectedCells = [];
        let foundWords = [];
        let gameStarted = false;

        function renderGrid() {
            gridEl.innerHTML = '';
            const rows = gridData.length;
            const cols = gridData[0].length;
            gridEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.textContent = gridData[r][c];
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    gridEl.appendChild(cell);
                }
            }
        }

        function renderWordList() {
            wordListEl.innerHTML = '';
            wordsToFind.forEach(word => {
                const li = document.createElement('li');
                li.id = `word-${word}`;
                li.textContent = word;
                li.className = 'word-item';
                wordListEl.appendChild(li);
            });
        }

        function startUserTimer() {
            if (userTimer) clearInterval(userTimer);
            userStartTime = Date.now();
            userTimer = setInterval(() => {
                if (foundWords.length < wordsToFind.length) {
                    userTimeEl.textContent = ((Date.now() - userStartTime) / 1000).toFixed(2) + 's';
                }
            }, 100);
        }

        function resetGrid() {
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.classList.remove('found', 'selected');
            });
            document.querySelectorAll('.word-item').forEach(item => {
                item.classList.remove('found');
            });
            foundWords = [];
            selectedCells = [];
            isSelecting = false;
            simpleTimeEl.textContent = 'N/A';
            trieTimeEl.textContent = 'N/A';
        }

        startPlayBtn.addEventListener('click', () => {
            if (gameStarted) return;
            resetGrid();
            gameStarted = true;
            gridEl.classList.remove('disabled-grid');
            startUserTimer();
            startPlayBtn.disabled = true;
            startPlayBtn.style.opacity = '0.5';
        });

        resetGridBtn.addEventListener('click', () => {
             if (gameStarted) resetGrid();
        });
        
        closeModalBtn.addEventListener('click', () => winModal.classList.remove('visible'));

        gridEl.addEventListener('mousedown', (e) => {
            if (!gameStarted || !e.target.classList.contains('grid-cell')) return;
            isSelecting = true;
            selectedCells = [e.target];
            e.target.classList.add('selected');
        });

        gridEl.addEventListener('mouseover', (e) => {
            if (isSelecting && e.target.classList.contains('grid-cell') && !selectedCells.includes(e.target)) {
                selectedCells.push(e.target);
                e.target.classList.add('selected');
            }
        });

        document.body.addEventListener('mouseup', () => {
            if (isSelecting) {
                isSelecting = false;
                const selectedWord = selectedCells.map(cell => cell.textContent).join('');
                const reversedWord = selectedWord.split('').reverse().join('');

                let foundMatch = false;
                if (wordsToFind.includes(selectedWord) && !foundWords.includes(selectedWord)) {
                    foundWords.push(selectedWord);
                    markWordAsFound(selectedWord, selectedCells);
                    foundMatch = true;
                } else if (wordsToFind.includes(reversedWord) && !foundWords.includes(reversedWord)) {
                    foundWords.push(reversedWord);
                    markWordAsFound(reversedWord, selectedCells);
                    foundMatch = true;
                }

                if (!foundMatch) {
                    selectedCells.forEach(cell => cell.classList.remove('selected'));
                }
                selectedCells = [];
                if (foundMatch) checkWin();
            }
        });

        function markWordAsFound(word, cells) {
            const wordEl = document.getElementById(`word-${word}`);
            if (wordEl && !wordEl.classList.contains('found')) {
                wordEl.classList.add('found');
                cells.forEach(cell => {
                    cell.classList.remove('selected');
                    cell.classList.add('found');
                });
            }
        }

        function checkWin() {
            if (foundWords.length === wordsToFind.length) {
                clearInterval(userTimer);
                const timeTaken = userTimeEl.textContent;

                fetch(`/mark_game_played/${levelKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ human_time: timeTaken.replace('s','') })
                });
                
                winMessage.textContent = `You found all the words in ${timeTaken}!`;
                winModal.classList.add('visible');
            }
        }

        function runAI(algo) {
            fetch('/solve_word_search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ grid: gridData, words: wordsToFind, level_key: levelKey, algorithm: algo })
            })
            .then(res => res.json())
            .then(data => {
                resetGrid();
                const timeEl = (algo === 'Simple') ? simpleTimeEl : trieTimeEl;
                timeEl.textContent = parseFloat(data.ai_time).toFixed(9) + 's';
                
                for (const word in data.found_words) {
                    const path = data.found_words[word];
                    const cells = path.map(([r, c]) => gridEl.querySelector(`[data-row='${r}'][data-col='${c}']`));
                    markWordAsFound(word, cells);
                    if (!foundWords.includes(word)) {
                        foundWords.push(word);
                    }
                }
            });
        }
        
        renderGrid();
        renderWordList();
        gridEl.classList.add('disabled-grid');

        // Starfield animation
        const starField = document.getElementById('star-field');
        if (starField && !starField.hasChildNodes()) {
            for (let i = 0; i < 200; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 3;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.left = `${Math.random() * 100}%`;
                star.style.animationDuration = `${2 + Math.random() * 3}s`;
                star.style.animationDelay = `${Math.random() * 5}s`;
                starField.appendChild(star);
            }
        }
    </script>
</body>
</html>
