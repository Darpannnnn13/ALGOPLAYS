<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Math Quiz | {{ difficulty.upper() }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<style>
    .star-field {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #0C0A1A;
        overflow: hidden;
        z-index: -1;
    }
    .star {
        position: absolute; background: white; border-radius: 50%;
        animation: twinkle linear infinite;
    }
    @keyframes twinkle {
        0%, 100% { transform: scale(0.5); opacity: 0.5; }
        50% { transform: scale(1); opacity: 1; }
    }
</style>
<body class="bg-gray-900 text-white p-6 flex flex-col items-center justify-center min-h-screen">

    <div id="star-field" class="star-field"></div>
    <div id="game-container" class="w-full max-w-2xl text-center">
        <div class="flex justify-between items-center mb-4">
            <div class="text-lg">Score: <span id="score" class="font-bold">0</span></div>
            <div class="text-2xl font-bold text-green-400">{{ difficulty.capitalize() }} Challenge {{level}}</div>
            <div class="text-lg">Time: <span id="timer" class="font-bold text-yellow-400">{{ level_data.time_limit }}</span>s</div>
        </div>

        <div class="bg-gray-800 p-8 rounded-lg shadow-lg">
            <div id="progress" class="text-gray-400 mb-4">Question 1 / {{ level_data.questions|length }}</div>
            <h2 id="question-text" class="text-3xl mb-6">Loading question...</h2>
            <div id="options-grid" class="grid grid-cols-2 gap-4">
                </div>
        </div>
    </div>

    <div id="end-screen" class="hidden w-full max-w-2xl text-center bg-gray-800 p-8 rounded-lg shadow-lg">
        <h2 class="text-4xl font-bold text-green-400 mb-4">Time's Up!</h2>
        <p class="text-xl mb-2">Your final score is:</p>
        <p id="final-score" class="text-6xl font-bold text-yellow-400 mb-8">0</p>
        <div class="flex justify-center gap-4">
            <button onclick="window.location.reload()" class="px-6 py-3 bg-blue-500 text-black rounded font-bold hover:bg-blue-400">Play Again</button>
            <a href="/math_quiz/levels" class="px-6 py-3 bg-gray-600 text-white rounded font-bold hover:bg-gray-500">Show Levels</a>
            
            {% if next_level_data %}
                <a href="{{ url_for('play_math_quiz_level', difficulty=next_level_data.difficulty, level=next_level_data.level) }}" 
                   class="px-6 py-3 bg-green-500 text-black rounded font-bold hover:bg-green-400 animate-pulse">
                   Next Level ➡️
                </a>
            {% endif %}
        </div>
    </div>

    <script>
        const levelData = {{ level_data | tojson }};
        const levelKey = `math_quiz_{{ difficulty }}-{{ level }}`;

        const scoreEl = document.getElementById('score');
        const timerEl = document.getElementById('timer');
        const progressEl = document.getElementById('progress');
        const questionTextEl = document.getElementById('question-text');
        const optionsGridEl = document.getElementById('options-grid');
        const gameContainerEl = document.getElementById('game-container');
        const endScreenEl = document.getElementById('end-screen');
        const finalScoreEl = document.getElementById('final-score');

        let score = 0;
        let currentQuestionIndex = 0;
        let timeLeft = levelData.time_limit;
        let timerInterval;

        // --- No changes to startGame(), displayQuestion(), selectAnswer(), startTimer() ---
        function startGame() {
            score = 0;
            currentQuestionIndex = 0;
            timeLeft = levelData.time_limit;
            scoreEl.textContent = score;
            timerEl.textContent = timeLeft;
            displayQuestion();
            startTimer();
        }

        function displayQuestion() {
            const question = levelData.questions[currentQuestionIndex];
            progressEl.textContent = `Question ${currentQuestionIndex + 1} / ${levelData.questions.length}`;
            questionTextEl.textContent = question.text;
            optionsGridEl.innerHTML = '';

            question.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'p-4 bg-gray-700 rounded text-xl hover:bg-gray-600 transition';
                button.onclick = () => selectAnswer(option, button);
                optionsGridEl.appendChild(button);
            });
        }

        function selectAnswer(selectedOption, buttonEl) {
            const question = levelData.questions[currentQuestionIndex];
            const isCorrect = selectedOption === question.answer;

            buttonEl.classList.remove('bg-gray-700');
            buttonEl.classList.add(isCorrect ? 'bg-green-500' : 'bg-red-500');
            document.querySelectorAll('#options-grid button').forEach(b => b.disabled = true);

            if (isCorrect) {
                score++;
                scoreEl.textContent = score;
            }

            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < levelData.questions.length) {
                    displayQuestion();
                } else {
                    endGame();
                }
            }, 1000);
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }
        
        // === START MODIFICATION ===
        function endGame() {
            clearInterval(timerInterval);
            gameContainerEl.classList.add('hidden');
            endScreenEl.classList.remove('hidden');
            finalScoreEl.textContent = score;

            // Calculate the time taken to complete the quiz
            const timeTaken = levelData.time_limit - timeLeft;

            // Save both the score and the time taken
            fetch(`/mark_game_played/${levelKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    user_score: score,
                    time_taken: timeTaken 
                })
            });
        }
        // === END MODIFICATION ===

        // Start the game as soon as the page loads
        startGame();

        // Starfield animation
        const starField = document.getElementById('star-field');
        if (starField && !starField.hasChildNodes()) {
            for (let i = 0; i < 200; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 3;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.left = `${Math.random() * 100}%`;
                star.style.animationDuration = `${2 + Math.random() * 3}s`;
                star.style.animationDelay = `${Math.random() * 5}s`;
                starField.appendChild(star);
            }
        }
    </script>
</body>
</html>